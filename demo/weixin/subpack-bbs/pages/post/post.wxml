<!--subpack-bbs/pages/post.wxml-->
<!-- 顶部自定义导航 -->
<view class="navigation" id="navigation">
    <kk-navigation-bar title="{{ pageTitle }}" bind:navHeightFun="navHeightFun"></kk-navigation-bar>
</view>

<view class="post" style="padding-top: {{ navHeight ? navHeight - 1 : 88 }}px; box-sizing: border-box;">
    <!-- 图集部分/规则部分 -->
    <view class="post-top">
        <!-- 三种类型1、图集 2、视屏贴 3、长图 -->
        <view class="atlas" wx:if="{{ postDetails.structureType == 7 }}">
            <swiper
                class="swiper"
                indicator-dots="{{false}}"
                indicator-color="rgba(255,255,255,0.5)"
                autoplay="{{ false }}"
                vertical="{{ false }}"
                bindchange="swiperChange"
                style="height: {{ postDetails.atlasHeight }}rpx"
            >
                <block wx:for="{{ postDetails.atlasLists }}" wx:key="index">
                    <swiper-item class="swiper-item">
                        <view data-image="{{item.content}}" class="atlas-details" data-image="{{ item.content }}" bindtap="atlasPreviewImgs">
                            <kk-cover
                                post
                                src="{{ item.content }}"
                                height="{{ item.height }}"
                                width="{{ item.width }}"
                                mode="{{ 'widthFix' }}"
                                style="margin-top: -{{ item.offsetY }}rpx">
                            </kk-cover>

                            <!-- 查看全部 -->
                            <view data-image="{{item.content}}" catchtap="atlasPreviewImgs" class="lookAll {{item.exceedH && swiperCurrent == index ? 'show' : ''}}">查看完整图片</view>
                        </view>
                    </swiper-item>
                </block>
            </swiper>

            <!-- 自定义指示点 -->
            <view class="dots"> 
                <block wx:for="{{ postDetails.atlasLists }}" wx:key="index"> 
                    <view class="dot{{index == swiperCurrent ? ' active' : ''}}"></view> 
                </block> 
            </view>

            <!-- 帖子数量显示 -->
            <view class="nums">{{ swiperCurrent + 1 }}/{{ postDetails.atlasLists.length }}</view>
        </view>

        <!-- 视频帖 -->
        <view class="video" wx:if="{{ postDetails.structureType == 6 }}">
            <video 
                id="myVideo" 
                class="video-windows"
                style="height: {{ postDetails.videoData.height }}px"
                src="{{ postDetails.videoData.content }}" 
                title="{{ '' }}"
                autoplay
                controls
                direction="{{ direction }}"
                binderror="videoErrorCallback"
                object-fit="{{ objectFit }}"
                enable-danmu="{{ false }}"
                danmu-btn="{{ false }}"
                show-center-play-btn="{{ controls }}"
                show-play-btn="{{true}}"
                show-progress="{{ true }}"
                show-play-btn="{{ true }}"
                show-mute-btn="{{ true }}"
                show-screen-lock-button="{{ false }}"
                show-fullscreen-btn="{{ true }}"
                enable-play-gesture="{{ true }}"
                auto-pause-if-open-native="{{ true }}"
                auto-pause-if-navigate="{{ true }}"
                picture-in-picture-mode="{{['push', 'pop']}}"
                bindplay="bindplay"
                bindpause="bindpause"
                bindended="bindended"
                bindfullscreenchange="bindfullscreenchange"
                bindenterpictureinpicture='bindVideoEnterPictureInPicture'
                bindleavepictureinpicture='bindVideoLeavePictureInPicture'
                >
            </video>

            <!-- 自定义暂定/播放 -->
            <!-- <view class="pause" wx:if="{{ !videoStatus }}">
                <image class="" src="/subpack-bbs/pages/images/pause.png" />
            </view> -->
              
            <!-- 自定义全屏/与自身携带控件冲突 -->
            <!-- <image class="full-screen" catchtap="bindVideoFullScreen" src="/subpack-bbs/pages/images/full-screen.png" /> -->
        </view>

        <!-- 长图帖 -->
        <view class="longPic {{ miMode }}" wx:if="{{ postDetails.structureType == 8 }}">
            <block wx:for="{{ postDetails.longPics }}" wx:key="index">
                <kk-cover
                    src="{{ item.content }}"
                    height="{{ item.height }}"
                    width="{{ 750 }}"
                    mode="{{ 'widthFix' }}">
                </kk-cover>
            </block>
        </view>
    </view>

    <!-- 固定内容部分 -->
    <view class="middle" wx:if="{{ postDetails.structureType }}" style="padding-top: {{ postDetails.structureType == 7 ? 2 : 32 }}rpx">
        <view class="infos">
            <text class="name">{{ postDetails.authorInfo.nickname }}</text>
            <view class="msg" hidden="{{ !postDetails.strViewCount }}">
                <text>{{ postDetails.createTime }}</text><text>{{ postDetails.strViewCount }}观看</text>
            </view>
        </view>
        <view class="article">
            <block>
                <!-- <rich-text nodes="{{postDetails.richText}}"></rich-text> -->
                <text>{{postDetails.richText}}</text>
            </block>
        </view>
        <view class="labels" wx:if="{{ postDetails.labels.length }}">
            <view class="labels-list">
                <view class="detail" wx:for="{{ postDetails.labels }}" wx:key="index">
                    <image src="/subpack-bbs/pages/images/label.png"></image>
                    <text>{{ item }}</text>
                </view>
            </view>
        </view>

        <!-- 关联专题 -->
        <view wx:if="{{ relatedTopic }}" style="padding-top: {{ postDetails.labels.length ? 44 : 18 }}rpx" >
            <view class="rel-topic" data-type="{{ relatedTopic.action_protocol.type }}" data-id="{{ relatedTopic.action_protocol.parent_target_id }}" bindtap="readTopic"> 
                <view class="pic">
                    <kk-cover src="{{ relatedTopic.cover_image_url }}" height="{{ 168 }}" width="{{ 304 }}" mode="{{ 'widthFix' }}">
                    </kk-cover>
                </view>
                
                <view class="right">
                    <view class="title">{{ relatedTopic.title }}</view>
                    <view class="tag">
                        <text class="tag-txt">{{ relatedTopic.subtitle }}</text>
                    </view>
                    <view class="rel-infos">
                        <view class="fav">
                            <image class="fav-img" src="https://static3w.kuaikanmanhua.com/assets/img/remote_images/icons/post-rel-focus_7f482d7.png"></image>
                            <text class="fav-txt">{{ relatedTopic.favCount }}关注</text>
                        </view>
                        <view class="readbtn">阅读漫画</view>
                    </view>
                </view>
            </view>
        </view>
    </view>
      
    <!-- 双排瀑布流（猜你想看） -->
    <view class="more {{ postMoreList.length ? 'borderTop' : '' }}" id="more-list">
        <view class="more-title" hidden="{{ !postMoreList.length }}">猜你想看</view>
        <view class="more-post">
            <!-- 第四种方案，图片加载实际高度排，抽象节点-->
            <kk-waterfall
                id="waterfall"
                generic:item="kk-waterfall-item"
                list="{{postMoreList || []}}"
                idKey="id"
                imageKey1="recommendCover"
                imageKey2="content"
                colNum="2"
                gutter="18rpx"
                bind:loadingChange="onLoadingChange">
            </kk-waterfall>

            <!-- 默认加载中 -->
            <view hidden="{{ !postMoreList.length }}" style="height: {{ noMore && showFixed ? 100 : 40}}px;">
                <kk-bottom
                    loading="{{ loading || !noMore }}"
                    finish="{{ noMore }}"
                />
            </view>

            <!-- <view wx:if="{{ noMore && showFixed }}" style="width: 100%;height: 160rpx"></view> -->
        </view>
    </view>
</view>

<!-- 固定悬浮球/仅qq存在 -->
<view wx:if="{{ channel == 'qq' }}" class="suspend" style="transform: translateX({{ suspendAnimation ? '0' : '82' }}rpx);" bindtap="toHome">
    <image src="/subpack-bbs/pages/images/home.png" />
    <text>首页</text>
</view>

<!-- 左侧返回首页按钮 -->
<view class="super-left">
    <view class="btn-home"
        wx:if="{{ nonstopPage }}"
        bindtap="goHomeFun">
            <text>返回首页</text>
            <image src="https://static3w.kuaikanmanhua.com/assets/img/remote_images/icons/tools-arrow_08a91b1.png"></image>
    </view>
</view>

<!-- 底部固定显示区域 -->
<view class="fixed" style="transform: translateY({{ showFixed ? '0' : '236' }}rpx);height: {{ ipxFixed }}rpx">
    <view class="fixed-detail">
        <view class="bullet"></view>
        <view class="praise" data-id="{{ postDetails.id }}" bindtap="clickPraise">
            <image src="/subpack-bbs/pages/images/praise-{{ postDetails.isLiked ? 'active' : 'default' }}.png"></image>
            <text>{{ postDetails.strLikeCount }}</text>
        </view>
        <button class="share" open-type="share" bindtap="shareClick" share-type="{{27}}">
            <image src="/subpack-bbs/pages/images/{{ channel }}.png"></image>
            <text>分享给好友</text>
        </button>
    </view>
</view>

<!-- 公共toast -->
<kk-toast toast="{{ toast }}"></kk-toast>